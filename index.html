<!DOCTYPE html>
<html lang="en">
<head>
	<meta charset="UTF-8">
	<title>Document</title>
	<style type="text/css">
		body{margin:0;text-align:center;overflow-x: hidden;}
		.container{margin:100px auto;width:1280px;height:720px;position:relative;perspective:1000px;background-image:url(images/1progressiveMotion/1.jpg);}
		.simple-tile{position:absolute;}
		.brick{float:left;transform-style:preserve-3d;position:relative;}
		.brick .front,.brick .back{position:absolute;width:100%;height:100%;left:0;}
		.brick .back{transform:rotateY(-180deg);backface-visibility:hidden;}
		.cover-page,.back-page,.bottom-page,.active-page{position:absolute;width:50%;height:100%;}
		.cover-page,.back-page{width:100%;height:100%;}
		.active-page,.bottom-page{left:50%;}
		.active-page{transform-style:preserve-3d;transform-origin:left center;}
		.cover-page,.bottom-page{background-position:right center;}
		.cover-page,.back-page{backface-visibility:hidden;}
		.back-page{transform:rotateY(180deg);}
		.cube-front,.cube-back{position:absolute;width:100%;height:100%;left:0;backface-visibility:hidden;}
		.cube-back{transform:rotateY(90deg);}
		table{table-layout: fixed;margin:20px auto;border:2px solid #333;border-collapse: collapse;}
		th,td{border:1px solid #333;width:200px;line-height: 40px;}
	</style>
</head>
<body>
	<div class="container">
		
	</div>
	<button id="explode">Explode</button>
	<button id="blowaway">Blowaway</button>
	<button id="rotate">Rotate</button>
	<button id="flip">Flip</button>
	<button id="cube">Cube</button>
	<table>
		<thead>
			<tr>
				<th></th>
				<th>Explode</th>
				<th>Blowaway</th>
				<th>Rotate</th>
				<th>Flip</th>
				<th>Cube</th>
			</tr>
		</thead>
		<tbody>
			<tr>
				<th>IE</th>
				<td>Pass</td>
				<td>Pass</td>
				<td>只显示正面</td>
				<td>backface-visibility失效</td>
				<td>Pass</td>
			</tr>
			<tr>
				<th>Firefox</th>
				<td>Pass</td>
				<td>Pass</td>
				<td>Pass</td>
				<td>Pass</td>
				<td>Pass</td>
			</tr>
			<tr>
				<th>Chrome</th>
				<td>Pass</td>
				<td>之前左边有闪烁</td>
				<td>backface-visibility在chrome下有性能问题</td>
				<td>Pass</td>
				<td>Pass</td>
			</tr>
			<tr>
				<td colspan="6">*父级的 preserve-3d 会在chrome下造成rotate flip的闪烁,Chrome下的blowaway之前在左边会有闪烁问题，后来不知道发生了什么又好了<br>
				*Firefox下setTimeout给0会出现第一个小块瞬间完成动画的情况<br>
				*IE下两个面紧贴的情况下，backface-visibility会失效</td>
			</tr>
		</tbody>
	</table>
	<script type="text/javascript">
		function ProgressiveMotion(container,rows,cols){
			this.con = container;
			this.rows = rows;
			this.cols = cols;
			this.width = parseFloat(getComputedStyle(container,'')['width']);
			this.height = parseFloat(getComputedStyle(container,'')['height']);
			this.tileWidth = this.width/cols;
			this.tileHeight = this.height/rows;
			this.centroid = {x:this.width/2,y:this.height/2};
			this.diagonalLength = Math.sqrt(this.width*this.width + this.height*this.height);
			this.isOperational = true;
		}
		ProgressiveMotion.prototype = {
			constructor : ProgressiveMotion,
			setBg : function (bgs){
				this.bgs = bgs;
				this.curBg = 0;
				return this;
			},
			explode : function (){
				if(!this.isOperational)
					return;
				this.isOperational = false;
				var tile,
					disX,
					disY,
					disXY,
					disZ,
					disSquare,
					angleZ,
					angleXY,
					force,
					that = this;
				if(this.curMode !== 'tiles'){
					this.curMode = 'tiles';
					this.con.innerHTML = '';
					that.con.style.transformStyle = 'flat';
					if(!this.tiles){
						this.createTiles();
					}
					this.appendTiles();
				}
				this.centroid.z = -Math.floor(this.centroid.x,this.centroid.y)/2;
				this.initialForce = this.centroid.z*this.centroid.z*500;
				this.setContainerBg();
				for(var i = 0;i < this.tiles.length;i++){
					tile = this.tiles[i];
					disX = tile.offsetLeft + this.tileWidth/2 - this.centroid.x;
					disY = tile.offsetTop + this.tileHeight/2 - this.centroid.y;
					angleXY = Math.atan2(disY,disX);
					disXY = disX*disX + disY*disY;
					disSquare = disXY + this.centroid.z*this.centroid.z;
					force = this.initialForce/disSquare;
					disXY = Math.sqrt(disXY);
					angleZ = Math.atan2(-this.centroid.z,disXY);
					disZ = Math.sin(angleZ)*force;
					force = Math.cos(angleZ)*force;
					disX = Math.cos(angleXY)*force;
					disY = Math.sin(angleXY)*force;
					tile.style.transition = '1s all cubic-bezier(0,1.1,1,1)';
					tile.style.opacity = 0;
					tile.style.transform = 'translate3d('+disX+'px,'+disY+'px,'+disZ+'px) rotate3d('+Math.random()+','+Math.random()+','+Math.random()+',90deg)';
				}
			},
			blowaway : function (){
				if(!this.isOperational)
					return;
				var that = this,
					sum = this.rows + this.cols - 2,
					angle = Math.atan2(-this.height,-this.width) + Math.random()*Math.PI/6;
				this.isOperational = false;
				if(this.curMode !== 'tiles'){
					this.curMode = 'tiles';
					this.con.innerHTML = '';
					that.con.style.transformStyle = 'flat';
					if(!this.tiles){
						this.createTiles();
					}
					this.appendTiles();
				}
				this.setContainerBg();
				for(var i = 0;i < this.rows;i++){
					for(var j = 0;j < this.cols;j++){
						(function (index){
							var tile = that.tiles[index],
								posIndex = i + j;
							setTimeout(function (){
								var dis = that.diagonalLength*posIndex/sum/1.3 + 20;
									disX = Math.cos(angle)*dis,
									disY = Math.sin(angle)*dis,
									disZ = 400*index/sum + 20;
								tile.style.transition = 'all 1s cubic-bezier(0,0,0.4,1)';
								tile.style.opacity = 0;
								tile.style.transform = 'translate3d('+disX+'px,'+disY+'px,'+disZ*Math.random()+'px) rotate3d('+Math.random()+','+Math.random()+','+Math.random()+',180deg)';
							},(sum - posIndex)*100 + 20);
						})(i*this.cols + j);
					}
				}
			},
			rotate : function (){
				if(!this.isOperational)
					return;
				this.isOperational = false;
				var that = this;
				if(this.curMode !== 'rotate'){
					this.curMode = 'rotate';
					this.con.innerHTML = '';
					this.con.style.backgroundImage = 'none';
					that.con.style.transformStyle = 'flat';
					if(!this.bricks){
						var brick;
						this.bricks = [];
						for(var i = 0;i < this.rows;i++){
							for(var j = 0;j < this.cols;j++){
								brick = document.createElement('div');
								brick.className = 'brick';
								brick.innerHTML = '<span class="front"></span><span class="back"></span>';
								brick.style.width = this.tileWidth + 'px';
								brick.style.height = this.tileHeight + 'px';
								brick.children[0].style.backgroundPosition = brick.children[1].style.backgroundPosition = -j*this.tileWidth + 'px ' + -i*this.tileHeight + 'px';
								this.bricks.push(brick);
							}
						}
						this.bricks[this.bricks.length - 1].addEventListener('transitionend',function (){
							var bgUrl = 'url(' + that.bgs[that.curBg] + ')',
								nextBgUrl = 'url('+that.bgs[(that.curBg + 1)%that.bgs.length]+')';
							for(var i = 0;i < that.bricks.length;i++){
								that.bricks[i].style.transition = 'none';
								that.bricks[i].style.transform = '';
								that.bricks[i].children[0].style.backgroundImage = bgUrl;
								that.bricks[i].children[1].style.backgroundImage = nextBgUrl;
							}
							that.isOperational = true;
						},false);
					}
					this.appendBricks();
				}
				this.curBg = (this.curBg + 1)%this.bgs.length;
				for(var i = 0;i < this.rows;i++){
					for(var j = 0;j < this.cols;j++){
						(function (index){
							var brick = that.bricks[index],
								posIndex = i + j;
							brick.style.transition = '1s all ease';
							setTimeout(function (){
								brick.style.transform = 'rotateY(180deg)';
							},posIndex*100 + 20);
						})(i*this.cols + j);
					}
				}
			},
			flip : function (){
				if(!this.isOperational)
					return;
				var that = this;
				this.isOperational = false;
				if(this.curMode !== 'flip'){
					this.con.innerHTML = '';
					this.curMode = 'flip';
					this.con.style.backgroundImage = 'url('+this.bgs[this.curBg]+')';
					that.con.style.transformStyle = 'flat';
					if(!this.pages){
						this.con.innerHTML = '<div class="bottom-page"></div><div class="active-page"><div class="back-page"></div><div class="cover-page"></div></div>';
						this.pages = {bottom:this.con.children[0],active:this.con.children[1],back:this.con.children[1].children[0],cover:this.con.children[1].children[1]};
						this.pages.active.addEventListener('transitionend',function (){
							this.children[1].style.backgroundImage = that.con.style.backgroundImage = 'url('+that.bgs[that.curBg]+')';
							this.children[0].style.backgroundImage = that.pages.bottom.style.backgroundImage = 'url('+that.bgs[(that.curBg + 1)%that.bgs.length]+')';
							this.style.transition = 'none';
							this.style.transform = 'rotateY(0deg)';
							that.con.style.perspective = '1000px';
							that.isOperational = true;
						},false);
					}else{
						this.con.appendChild(this.pages.bottom);
						this.con.appendChild(this.pages.active);
					}
					this.pages.cover.style.backgroundImage = 'url('+this.bgs[this.curBg]+')';
					this.pages.back.style.backgroundImage = this.pages.bottom.style.backgroundImage = 'url('+this.bgs[(this.curBg + 1)%this.bgs.length]+')';
				}
				this.con.style.perspective = '2000px';
				this.curBg = (this.curBg + 1)%this.bgs.length;
				setTimeout(function (){
					that.pages.active.style.transition = 'all 1s ease';
					that.pages.active.style.transform = 'rotateY(-180deg)';
				},20);
			},
			cube : function (){
				if(!this.isOperational)
					return;
				this.isOperational = false;
				var that = this;
				if(this.curMode !== 'cube'){
					this.curMode = 'cube';
					this.con.style.backgroundImage = 'none';
					this.con.innerHTML = '';
					this.con.style.transformStyle = 'preserve-3d';
					if(!this.cubeFaces){
						var front = document.createElement('front'),
							back = document.createElement('back');
						front.className = 'cube-front';
						back.className = 'cube-back';
						front.style.transformOrigin = back.style.transformOrigin = '50% 50% ' + -this.width/2 + 'px';
						back.style.transform = 'rotateY(90deg)';
						this.cubeFaces = {};
						this.cubeFaces.front = front;
						this.cubeFaces.back = back;
						back.addEventListener('transitionend',function (){
							front.style.transition = back.style.transition = 'none';
							that.curBg = (that.curBg + 1)%that.bgs.length;
							front.style.backgroundImage = 'url('+that.bgs[that.curBg]+')';
							back.style.backgroundImage = 'url('+that.bgs[(that.curBg + 1)%that.bgs.length]+')';
							front.style.transform = 'rotateY(0deg)';
							back.style.transform = 'rotateY(90deg)';
							that.isOperational = true;
						},false);
					}
					this.con.appendChild(this.cubeFaces.front);
					this.con.appendChild(this.cubeFaces.back);
					this.cubeFaces.front.style.backgroundImage = 'url('+this.bgs[this.curBg]+')';
					this.cubeFaces.back.style.backgroundImage = 'url('+this.bgs[(this.curBg + 1)%this.bgs.length]+')';
				}
				setTimeout(function (){
					that.cubeFaces.front.style.transition = that.cubeFaces.back.style.transition = '1s all ease';
					that.cubeFaces.front.style.transform = 'rotateY(-90deg)';
					that.cubeFaces.back.style.transform = 'rotateY(0deg)';
				},20);
			},
			createTiles : function (){
				var that = this;
				this.tiles = [];
				for(var i = 0;i < this.rows;i++){
					for(var j = 0;j < this.cols;j++){
						tile = document.createElement('span');
						tile.className = 'simple-tile';
						tile.style.width = this.tileWidth + 'px';
						tile.style.height = this.tileHeight + 'px';
						tile.style.left = j*this.tileWidth + 'px';
						tile.style.top = i*this.tileHeight + 'px';
						tile.style.backgroundPosition = -j*this.tileWidth + 'px -' + i*this.tileHeight + 'px';
						tile.style.backgroundImage = 'url('+this.bgs[this.curBg]+')';
						this.tiles.push(tile);
						this.con.appendChild(tile);
					}
				}
				this.addTileListener();
			},
			appendChildren : function (children,fn){
				for(var i = 0;i < children.length;i++){
					this.con.appendChild(children[i]);
					fn.call(this,children[i]);
				}
			},
			appendTiles : function (){
				this.appendChildren(this.tiles,function (tile){
					tile.style.backgroundImage = 'url('+this.bgs[this.curBg]+')';
				});
			},
			appendBricks : function (){
				var bgUrl = 'url(' + this.bgs[this.curBg] + ')',
					nextBgUrl = 'url('+this.bgs[(this.curBg + 1)%this.bgs.length]+')';
				this.appendChildren(this.bricks,function (brick){
					console.log(bgUrl);
					brick.children[0].style.backgroundImage = bgUrl;
					brick.children[1].style.backgroundImage = nextBgUrl;
				});
			},
			addTileListener : function (){
				var that = this;
				this.tiles[0].addEventListener('transitionend',function fn(){
					for(var i = 0;i < that.tiles.length;i++){
						that.tiles[i].style.transition = 'none';
						that.tiles[i].style.transform = '';
						that.tiles[i].style.opacity = 1;
						that.tiles[i].style.backgroundImage = 'url('+that.bgs[that.curBg]+')';
					}
					that.isOperational = true;
				},false);
			},
			setContainerBg : function (){
				this.curBg = (this.curBg + 1)%this.bgs.length;
				this.con.style.backgroundImage = 'url('+this.bgs[this.curBg]+')';
			}
		}
		var pm = new ProgressiveMotion(document.querySelector('.container'),5,10).setBg(['images/1progressiveMotion/1.jpg','images/1progressiveMotion/2.jpg','images/1progressiveMotion/3.jpg','images/1progressiveMotion/4.jpg']);
		document.getElementById('explode').addEventListener('click',function (){
			pm.explode();
		},false);
		document.getElementById('blowaway').addEventListener('click',function (){
			pm.blowaway();
		},false);
		document.getElementById('rotate').addEventListener('click',function (){
			pm.rotate();
		},false);
		document.getElementById('flip').addEventListener('click',function (){
			pm.flip();
		},false);
		document.getElementById('cube').addEventListener('click',function (){
			pm.cube();
		},false);
	</script>
</body>
</html>